# The memory hierarchy
---
## 存储技术

###随机访问存储器
- 随机访问寄存器RAM (SRAM/DRAM)
	- SRAM 将每个位存储在一个*双稳态*的存储器单元  (高速缓存存储器)
	- DRAM 将每个位存储为对一个电容的充电 (主存)
- 非易失性存储器:即是关电后仍保存信息
	- 被称为只读存储器**ROM** 
		-  EPROM（Erasable Programmable)
		-  EEPROM (Electrically Erasable)
	- 闪存:基于EPPROM的非易失性存储器
- 访问主存
	- 数据流通过**总线**的共享电子电路在处理器和DRAM主存之前来回  
	- 总线事务、读事务和写事务
	
###磁盘
- 磁盘构造
	- 每个表面由一组称为磁道*track*的同心圆组成
	- 磁道被划分为一组扇区*sector* 每个扇区中包含相等数量的数据位
	- 扇区之前存在间隙*gap* 用于识别扇区的格式化位
	- 柱面*cylinder*是所有盘片表面上到主轴中心的距离相等**磁道**集合
- 磁盘容量
- 磁盘操作
	- 对扇区的访问时间:寻道时间/旋转时间(rotational latency)/传送时间 
- 链接I/O设备
	- 通用串行总线**USB**:连接各种外围I/O设备
	- 图形卡(或适配器):负责代表CPU上显示器上画像素
	- 主机总线适配器将磁盘连接到I/O总线 使用特别的主机总线接口的通信协议 (SCSI/SATA)
- 访问磁盘
	- CPU使用**内存映射I/O**的技术来向I/O设备发射命令 使用*I/O端口*
		- 发送一个命令字: 发起一个读并发送其他参数
		- 指明读的逻辑块号
		- 指明存储磁盘扇区内容的主存地址 
	- 直接内存访问 **DMA** 设备可以自己执行读或写总线事务而不需要CPU干涉且在完成传送后磁盘控制器通过给CPU发送一个中断信号来通过CPU

##局部性
- 对程序数据引用的局部性
- 取指令的局部性
- 局部性小结
	- 重复引用相同变量的程序具有良好的时间局部性
	- 步长越小空间局部性越好
	- 对于取指令来说 循环具有好的时间和空间局部性 

	
##存储器层次结构
### 存储器结构中的缓存
- **基本思想/本质**:位于k层的更快更小的存储设备作为位于k+1层的更大更慢的存储设备的缓存
- 缓存命中
	- 当程序需要第k+1层的某个数据对象d时 先再当前存储在第k层的一个块中查找d
- 缓存不命中
	- 第k层中没有缓存数据对象   	  	  
	- 覆盖一个现存的块的过程称为替换*replace*或驱逐*evict*
	- 替换策略 e.g. LRU
- 缓存不命中类型
	- 一个空的缓存被称为冷缓存 此类不命中称为**强制性不命中**或冷不命中
	- 由于放置策略导致对象会映射到同一个缓存块会引起**冲突不命中**
- 缓存管理


##高速缓存寄存器
- 通用的高速缓存存储器结构
	- 每个存储器地址有m位
	- 这样的一个机器的高速缓存被组成一个**S**个高速缓存组的数组
	- 每组包含**E**个高速缓存行 每行是由一个**B**字节的*数据块*组成 
	- 高速缓存大小 $C = S*E*B$ 
	- 当且仅当以下条件 组中的这一行才包含所寻找的信息(命中)
		- **1.有效位设置** 
		- **2.标记位于地址中标记位向匹配**
	- 为什么用中间的位做组索引?
		- 相邻的块总能映射到不同的高速缓存行 不然高速缓存只保存着一个块大小的数组内容(空缓存加载)  
- 直接映射高速缓存 $E=1$
	- 高速缓存确定一个请求是否命中 然后抽取被请求的字的过程(**读**)
		- 1.组选择
		- 2.行匹配 (有效位&标记位)
		- 3.字抽取 (块偏移)
	- 如果命中时的行替换
- 组相连高速缓存 $1 < E < C/B$
	- 缓存不命中时的**行**替换
		- LFU 最不常使用策略会替换某个时间窗口内引用最少的一行
		- LRU 最近最少使用策略会替换最后一次访问时间最久远的一行 
- 有关**写**的问题
	- 假设要写一个已经缓存的字w(写命中) 更新其低一层中的副本 
		- 1.直写 write-throught:立即将w的高速缓存块写回到紧接着的低一层
		- 2.**写回** write-back:当替换算法要驱逐这个更新块的时候再写到紧接着的低一层(减少总线流量 但需要维护一个额外的修改位 *dirtybit*)
	- 处理写不命中
		- 1.**写分配** write-allocate
		- 2.非写分配 
- **高速缓存行、组和块小结**  
	- 块: 固定大小的信息包 在高速缓存之间或高速缓存与主存之间传送
	- 行: 一个容器 存储**一个块**及其他信息
	- 组: 一个或多个行的集合 

## 编写高速缓存友好的代码
- 对局部变量的反复引用 因为编译器能够将它们缓存在寄存器文件中
- 步长为1的引用模式是好的
- C语言**以行优先**顺序存储数组

## 高速缓存对程序性能的影响(passed)


## 练习题
- 6.11用地址的高s位做组索引 运行一个高速缓存形式$(S,E,B,m) = (512,1,32,32)$
	- 标记位$t=32-(9+5)=18$
	- 数组中头的$2^{18}$个**块**都会映射到组0